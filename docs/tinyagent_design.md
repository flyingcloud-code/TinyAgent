# TinyAgent è®¾è®¡æ–‡æ¡£
*ç‰ˆæœ¬: 1.3*  
*åˆ›å»ºæ—¥æœŸ: 2025-06-01*  
*æ›´æ–°æ—¥æœŸ: 2025-06-02*  
*åŸºäº: TinyAgent v0.1.0*

## 1. é¡¹ç›®æ¦‚è¿°

TinyAgentæ˜¯ä¸€ä¸ªåŸºäºPythonçš„**ç®€åŒ–æ™ºèƒ½AIä»£ç†æ¡†æ¶**ï¼Œä¸“ä¸ºå¤æ‚ä»»åŠ¡è‡ªåŠ¨åŒ–è€Œè®¾è®¡ã€‚å®ƒé‡‡ç”¨**å•ä¸€æ™ºèƒ½æ¨¡å¼**è®¾è®¡ï¼Œé€šè¿‡ReActï¼ˆæ¨ç†ä¸è¡ŒåŠ¨ï¼‰å¾ªç¯æ¨¡å¼ï¼Œé›†æˆModel Context Protocol (MCP)å·¥å…·ç”Ÿæ€ç³»ç»Ÿï¼Œæ”¯æŒ100+å¤§è¯­è¨€æ¨¡å‹ï¼Œå…·å¤‡å¼ºå¤§çš„æ‰©å±•æ€§å’Œæç®€çš„é…ç½®ç®¡ç†ã€‚

### æ ¸å¿ƒä»·å€¼ä¸»å¼ 
- **ç®€åŒ–æ™ºèƒ½ä»£ç†**ï¼š**å•ä¸€æ™ºèƒ½æ¨¡å¼**ï¼Œæ— å¤æ‚å›é€€æœºåˆ¶ï¼Œä¸“æ³¨æ ¸å¿ƒAIèƒ½åŠ›
- **çœŸå®å·¥å…·æ‰§è¡Œ**ï¼šé€šè¿‡MCPåè®®é›†æˆ15+å®é™…å·¥å…·ï¼Œéæ¨¡æ‹Ÿæ“ä½œ
- **å¤šæ¨¡å‹æ”¯æŒ**ï¼šè‡ªåŠ¨è·¯ç”±OpenAIã€Googleã€Anthropicã€DeepSeekç­‰100+æ¨¡å‹
- **é›¶é…ç½®å¯åŠ¨**ï¼šæ™ºèƒ½é»˜è®¤é…ç½®ï¼Œå¼€ç®±å³ç”¨çš„AIä»£ç†ä½“éªŒ
- **é€æ˜å¯è°ƒè¯•**ï¼šè¯¦ç»†çš„æ‰§è¡Œè·Ÿè¸ªå’Œä¸­æ–‡å‹å¥½çš„çŠ¶æ€åé¦ˆ

## 2. æ ¸å¿ƒç‰¹æ€§

### 2.1 ç®€åŒ–æ™ºèƒ½ä»£ç†èƒ½åŠ› ğŸ§ 
- âœ… **å•ä¸€æ™ºèƒ½æ¨¡å¼**ï¼šå»é™¤å¤æ‚å›é€€æœºåˆ¶ï¼Œä¸“æ³¨ReActæ™ºèƒ½å¾ªç¯
- âœ… **çœŸå®å·¥å…·æ‰§è¡Œ**ï¼š15ä¸ªMCPå·¥å…·å®é™…æ‰§è¡Œï¼ŒåŒ…æ‹¬æ–‡ä»¶æ“ä½œã€ç½‘ç»œæœç´¢ç­‰
- âœ… **å¯¹è¯ä¸Šä¸‹æ–‡ç®¡ç†**ï¼šç»´æŠ¤å¤šè½®å¯¹è¯çš„å®Œæ•´ä¸Šä¸‹æ–‡
- âœ… **æ™ºèƒ½ä»»åŠ¡è§„åˆ’**ï¼šè‡ªåŠ¨åˆ†è§£å¤æ‚ä»»åŠ¡å¹¶é€‰æ‹©åˆé€‚å·¥å…·æ‰§è¡Œ
- âœ… **é€æ˜é”™è¯¯å¤„ç†**ï¼šç›´æ¥æš´éœ²é”™è¯¯ï¼Œä¾¿äºè°ƒè¯•å’Œé—®é¢˜å®šä½

### 2.2 å¤šæ¨¡å‹LLMæ”¯æŒ
- âœ… **åŒå±‚æ¶æ„**ï¼šOpenAIåŸç”Ÿå®¢æˆ·ç«¯ + LiteLLMç¬¬ä¸‰æ–¹æ¨¡å‹è·¯ç”±
- âœ… **è‡ªåŠ¨æ¨¡å‹æ£€æµ‹**ï¼šåŸºäºæ¨¡å‹å‰ç¼€è‡ªåŠ¨é€‰æ‹©é€‚å½“çš„å®¢æˆ·ç«¯
- âœ… **100+ æ¨¡å‹æ”¯æŒ**ï¼šGoogle Geminiã€Anthropic Claudeã€DeepSeekç­‰
- âœ… **OpenRouteré›†æˆ**ï¼šé»˜è®¤ä½¿ç”¨OpenRouterä½œä¸ºç»Ÿä¸€æ¨¡å‹ç½‘å…³

### 2.3 MCPå·¥å…·é›†æˆ ğŸ”§
- âœ… **15+çœŸå®å·¥å…·**ï¼šæ–‡ä»¶ç³»ç»Ÿ(11)ã€ç½‘ç»œæœç´¢(4)ç­‰å®é™…å¯ç”¨å·¥å…·
- âœ… **æ™ºèƒ½å·¥å…·æ³¨å†Œ**ï¼šè‡ªåŠ¨å‘ç°ã€æ³¨å†Œå’Œåˆ†ç±»MCPå·¥å…·
- âœ… **å¤šæœåŠ¡å™¨æ”¯æŒ**ï¼šåŒæ—¶è¿æ¥å¤šä¸ªMCPæœåŠ¡å™¨ï¼Œå®¹é”™æœºåˆ¶
- âœ… **ä¸‰ç§ä¼ è¾“åè®®**ï¼šstdioã€SSEã€HTTPæ”¯æŒ
- âœ… **ä¸­æ–‡å‹å¥½ç•Œé¢**ï¼šå·¥å…·åˆ—è¡¨ã€çŠ¶æ€ã€æ‰§è¡Œè¿‡ç¨‹çš„ä¸­æ–‡æ˜¾ç¤º

### 2.4 ç®€åŒ–é…ç½®ç®¡ç† âš™ï¸
- âœ… **æ™ºèƒ½é»˜è®¤é…ç½®**ï¼šå¼€ç®±å³ç”¨ï¼Œæœ€å°åŒ–é…ç½®éœ€æ±‚
- âœ… **ç¯å¢ƒå˜é‡ä¼˜å…ˆ**ï¼š.envæ–‡ä»¶ä¼˜å…ˆï¼Œç®€åŒ–APIå¯†é’¥ç®¡ç†
- âœ… **é…ç½®æ–‡ä»¶æ”¯æŒ**ï¼šå¼€å‘ã€ç”Ÿäº§ç¯å¢ƒé…ç½®æ–‡ä»¶
- âœ… **å®‰å…¨å‡­è¯ç®¡ç†**ï¼šAPIå¯†é’¥é€šè¿‡ç¯å¢ƒå˜é‡å®‰å…¨ç®¡ç†

### 2.5 ç”¨æˆ·ç•Œé¢ ğŸ¨
- âœ… **å‘½ä»¤è¡Œç•Œé¢**ï¼šç®€æ´çš„CLIå·¥å…·ï¼Œä¸“æ³¨æ ¸å¿ƒåŠŸèƒ½
- âœ… **ä¸­æ–‡äº¤äº’ä½“éªŒ**ï¼šå®Œæ•´çš„ä¸­æ–‡è¾“å‡ºå’ŒçŠ¶æ€åé¦ˆ
- âœ… **è¯¦ç»†æ‰§è¡Œè·Ÿè¸ª**ï¼šå·¥å…·è°ƒç”¨è¿‡ç¨‹çš„å®æ—¶æ˜¾ç¤º
- âœ… **çŠ¶æ€ç›‘æ§**ï¼šMCPæœåŠ¡å™¨å¥åº·æ£€æŸ¥å’Œå·¥å…·å¯ç”¨æ€§ç›‘æ§

## 3. ç³»ç»Ÿæ¶æ„ (ç®€åŒ–ç‰ˆ)

### 3.1 ç®€åŒ–æ¶æ„æ¦‚è§ˆ

```mermaid
graph TB
    %% User Layer
    User[ç”¨æˆ·] --> CLI[CLI Interface]
    
    %% Core Layer - SIMPLIFIED
    CLI --> TinyAgent[TinyAgent Core<br/>ç®€åŒ–æ™ºèƒ½ä»£ç†]
    TinyAgent --> |intelligent_mode=True| IntelligentAgent[Intelligent Agent<br/>ReActå¾ªç¯å¼•æ“]
    TinyAgent --> |intelligent_mode=False| BasicMCP[Basic MCP Mode<br/>ç›´æ¥å·¥å…·è°ƒç”¨]
    
    %% Intelligence Components - INTEGRATED
    IntelligentAgent --> ReasoningEngine[æ¨ç†å¼•æ“]
    IntelligentAgent --> TaskPlanner[ä»»åŠ¡è§„åˆ’å™¨]
    IntelligentAgent --> ToolSelector[å·¥å…·é€‰æ‹©å™¨]
    IntelligentAgent --> ActionExecutor[åŠ¨ä½œæ‰§è¡Œå™¨]
    
    %% LLM Layer
    IntelligentAgent --> LLMRouter[LLMè·¯ç”±å™¨]
    LLMRouter --> |OpenAIæ¨¡å‹| OpenAIClient[OpenAI Client]
    LLMRouter --> |ç¬¬ä¸‰æ–¹æ¨¡å‹| LiteLLM[LiteLLM Client]
    
    %% External Services
    OpenAIClient --> OpenAI[OpenAI API]
    LiteLLM --> OpenRouter[OpenRouter API]
    
    %% MCP Layer - SIMPLIFIED
    TinyAgent --> MCPManager[MCP Manager<br/>ç»Ÿä¸€è¿æ¥ç®¡ç†]
    MCPManager --> |stdio| FileSystem[æ–‡ä»¶ç³»ç»Ÿ<br/>11ä¸ªå·¥å…·]
    MCPManager --> |stdio| SearchService[æœç´¢æœåŠ¡<br/>4ä¸ªå·¥å…·]
    
    %% Configuration Layer - SIMPLIFIED  
    TinyAgent --> SimpleConfig[ç®€åŒ–é…ç½®<br/>envä¼˜å…ˆ]
    
    %% Styling
    classDef userLayer fill:#e1f5fe
    classDef coreLayer fill:#f3e5f5
    classDef intelligenceLayer fill:#e8f5e8
    classDef llmLayer fill:#fff3e0
    classDef mcpLayer fill:#fce4ec
    
    class User,CLI userLayer
    class TinyAgent coreLayer
    class IntelligentAgent,ReasoningEngine,TaskPlanner,ToolSelector,ActionExecutor intelligenceLayer
    class LLMRouter,OpenAIClient,LiteLLM llmLayer
    class MCPManager,FileSystem,SearchService,SimpleConfig mcpLayer
```

### 3.2 ç®€åŒ–æ‰§è¡Œæµç¨‹

```mermaid
graph TD
    Start([ç”¨æˆ·è¯·æ±‚]) --> CheckMode{intelligent_mode?}
    
    %% æ™ºèƒ½æ¨¡å¼æµç¨‹
    CheckMode -->|true| IntelligentMode[IntelligentAgent]
    IntelligentMode --> ReAct[ReActå¾ªç¯]
    ReAct --> Reasoning[æ¨ç†é˜¶æ®µ]
    Reasoning --> ToolSelection[å·¥å…·é€‰æ‹©]
    ToolSelection --> ActionExecution[æ‰§è¡ŒMCPå·¥å…·]
    ActionExecution --> Observation[è§‚å¯Ÿç»“æœ]
    Observation --> Complete{ä»»åŠ¡å®Œæˆ?}
    Complete -->|å¦| ReAct
    Complete -->|æ˜¯| Return[è¿”å›ç»“æœ]
    
    %% åŸºç¡€æ¨¡å¼æµç¨‹  
    CheckMode -->|false| BasicMode[åŸºç¡€MCPæ¨¡å¼]
    BasicMode --> DirectTool[ç›´æ¥å·¥å…·è°ƒç”¨]
    DirectTool --> Return
    
    %% é”™è¯¯å¤„ç† - ç®€åŒ–
    IntelligentMode -->|é”™è¯¯| Error[é€æ˜é”™è¯¯æŠ¥å‘Š]
    BasicMode -->|é”™è¯¯| Error
    Error --> Return
```

## 4. æ ¸å¿ƒç»„ä»¶è¯¦è§£ (ç®€åŒ–ç‰ˆ)

### 4.1 TinyAgent Core (`tinyagent/core/agent.py`) - ç®€åŒ–ä¸»å¼•æ“

**ä¸»è¦èŒè´£ï¼š**
- **å•ä¸€å…¥å£ç‚¹**ï¼šç»Ÿä¸€ç®¡ç†æ™ºèƒ½æ¨¡å¼å’ŒåŸºç¡€æ¨¡å¼
- **MCPè¿æ¥ç®¡ç†**ï¼šç»Ÿä¸€çš„è¿æ¥æ± å’Œå·¥å…·æ³¨å†Œ
- **é…ç½®ç®¡ç†**ï¼šç®€åŒ–çš„ç¯å¢ƒå˜é‡ä¼˜å…ˆé…ç½®

**æ ¸å¿ƒæ‰§è¡Œè·¯å¾„ï¼š**
```python
async def run(self, message: str, **kwargs) -> Any:
    """ç®€åŒ–çš„æ‰§è¡Œæµç¨‹ - æ— å¤æ‚å›é€€æœºåˆ¶"""
    if self.intelligent_mode and INTELLIGENCE_AVAILABLE:
        return await self._run_intelligent_mode(message, **kwargs)
    else:
        return await self._run_with_mcp_tools(message, **kwargs)
```

**å…³é”®æ”¹è¿›ï¼š**
- âŒ ç§»é™¤å¤æ‚å›é€€æœºåˆ¶ (~200è¡Œä»£ç )
- âœ… é€æ˜é”™è¯¯å¤„ç†ï¼Œä¾¿äºè°ƒè¯•
- âœ… ç»Ÿä¸€MCPå·¥å…·æ³¨å†Œæµç¨‹
- âœ… ç»„ä»¶å•ä¾‹åŒ–ï¼Œé¿å…é‡å¤åˆå§‹åŒ–

### 4.2 IntelligentAgent (`tinyagent/intelligence/intelligent_agent.py`) - æ™ºèƒ½æ ¸å¿ƒ

**ä¸»è¦èŒè´£ï¼š**
- **ReActå¾ªç¯ç®¡ç†**ï¼šæ¨ç†-è¡ŒåŠ¨-è§‚å¯Ÿå¾ªç¯
- **çœŸå®å·¥å…·æ‰§è¡Œ**ï¼š15ä¸ªMCPå·¥å…·çš„æ™ºèƒ½è°ƒç”¨
- **ä¸Šä¸‹æ–‡ç®¡ç†**ï¼šå¯¹è¯å†å²å’Œä»»åŠ¡çŠ¶æ€ç»´æŠ¤

**å·¥å…·æ³¨å†Œä¿®å¤ï¼š**
```python
def register_mcp_tools(self, mcp_tools: List[Dict[str, Any]]):
    """æ³¨å†ŒMCPå·¥å…·åˆ°æ™ºèƒ½ä»£ç†çš„æ‰€æœ‰ç»„ä»¶"""
    # æ³¨å†Œåˆ°å·¥å…·é€‰æ‹©å™¨
    self.tool_selector.add_tool_capability(...)
    # æ³¨å†Œåˆ°åŠ¨ä½œæ‰§è¡Œå™¨  
    self.action_executor.register_tool(...)
    # ğŸ”§ CRITICAL FIX: æ³¨å†Œåˆ°æ¨ç†å¼•æ“
    self.reasoning_engine.register_mcp_tools(self._mcp_tools)
    # æ›´æ–°ä»»åŠ¡è§„åˆ’å™¨
    self.task_planner.available_tools = available_tools
```

### 4.3 MCP Manager (`tinyagent/mcp/manager.py`) - ç»Ÿä¸€å·¥å…·ç®¡ç†

**ä¸»è¦èŒè´£ï¼š**
- **ç»Ÿä¸€è¿æ¥ç®¡ç†**ï¼šé¿å…é‡å¤è¿æ¥é€»è¾‘
- **å·¥å…·å‘ç°å’Œæ³¨å†Œ**ï¼š15ä¸ªå®é™…å·¥å…·çš„è‡ªåŠ¨å‘ç°
- **å®¹é”™æœºåˆ¶**ï¼šå•ä¸ªæœåŠ¡å™¨å¤±è´¥ä¸å½±å“å…¶ä»–æœåŠ¡å™¨

**å½“å‰å·¥å…·ç”Ÿæ€ç³»ç»Ÿï¼š**
- **filesystemæœåŠ¡å™¨** (11å·¥å…·): read_file, write_file, create_directory, list_directory, edit_file, move_file, search_files, get_file_info, directory_tree, list_allowed_directories, read_multiple_files
- **my-searchæœåŠ¡å™¨** (4å·¥å…·): google_search, get_web_content, get_weather_for_city_at_date, get_weekday_from_date

## 5. è®¾è®¡åŸåˆ™ä¸æ”¹è¿›æˆæœ

### 5.1 ç®€åŒ–ä¼˜å…ˆåŸåˆ™ ğŸ¯

**åŸåˆ™ï¼š** ä¼˜å…ˆç®€åŒ–æ¶æ„ï¼Œå‡å°‘ä¸å¿…è¦çš„å¤æ‚æ€§

**å®æ–½æˆæœï¼š**
- âŒ ç§»é™¤å¤æ‚å›é€€æœºåˆ¶ï¼šä»7æ¡æ‰§è¡Œè·¯å¾„ç®€åŒ–ä¸º2æ¡
- âŒ ç§»é™¤æœªä½¿ç”¨æ–¹æ³•ï¼š`_run_basic_mode()`, `_message_likely_needs_tools()`ç­‰
- âœ… å•ä¸€æ™ºèƒ½æ¨¡å¼ï¼šä¸“æ³¨ReActæ™ºèƒ½å¾ªç¯ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
- âœ… é€æ˜é”™è¯¯å¤„ç†ï¼šé”™è¯¯ç›´æ¥æš´éœ²ï¼Œä¾¿äºè°ƒè¯•

### 5.2 çœŸå®å·¥å…·ä¼˜å…ˆåŸåˆ™ ğŸ”§

**åŸåˆ™ï¼š** ä¼˜å…ˆæä¾›çœŸå®å¯ç”¨çš„å·¥å…·ï¼Œè€Œéæ¨¡æ‹Ÿæ“ä½œ

**å®æ–½æˆæœï¼š**
- âœ… 15ä¸ªçœŸå®MCPå·¥å…·ï¼šæ–‡ä»¶æ“ä½œã€ç½‘ç»œæœç´¢ç­‰å®é™…åŠŸèƒ½
- âœ… æ™ºèƒ½å·¥å…·æ³¨å†Œï¼šè‡ªåŠ¨å‘ç°ã€åˆ†ç±»å’Œæ³¨å†ŒMCPå·¥å…·
- âœ… å·¥å…·é€æ˜åº¦ï¼šè¯¦ç»†çš„å·¥å…·åˆ—è¡¨æ˜¾ç¤ºå’Œæ‰§è¡Œè·Ÿè¸ª
- âŒ ç§»é™¤æ¨¡æ‹Ÿå·¥å…·ï¼šä¸å†å›é€€åˆ°å‡çš„"search_information"ç­‰æ“ä½œ

### 5.3 ç”¨æˆ·ä½“éªŒä¼˜å…ˆåŸåˆ™ ğŸ¨

**åŸåˆ™ï¼š** æä¾›ä¸­æ–‡å‹å¥½ã€ç›´è§‚é€æ˜çš„ç”¨æˆ·ä½“éªŒ

**å®æ–½æˆæœï¼š**
- âœ… ä¸­æ–‡ç•Œé¢ï¼šå®Œæ•´çš„ä¸­æ–‡è¾“å‡ºå’ŒçŠ¶æ€åé¦ˆ
- âœ… è¯¦ç»†è·Ÿè¸ªï¼šå·¥å…·è°ƒç”¨è¿‡ç¨‹çš„å®æ—¶æ˜¾ç¤º
- âœ… æ™ºèƒ½åˆ†ç±»ï¼šå·¥å…·æŒ‰åŠŸèƒ½å’ŒæœåŠ¡å™¨åˆ†ç»„æ˜¾ç¤º
- âœ… çŠ¶æ€æŒ‡ç¤ºï¼šæœåŠ¡å™¨å¥åº·çŠ¶æ€å’Œå·¥å…·å¯ç”¨æ€§

## 6. å½“å‰çŠ¶æ€ä¸åç»­è®¡åˆ’

### 6.1 å·²å®Œæˆæˆæœ âœ…

1. **æ¶æ„ç®€åŒ–** (EPIC-007 Phase 1): 
   - ç§»é™¤å¤æ‚å›é€€æœºåˆ¶ï¼Œç®€åŒ–æ‰§è¡Œè·¯å¾„
   - ç»Ÿä¸€MCPå·¥å…·æ³¨å†Œæµç¨‹
   - é€æ˜é”™è¯¯å¤„ç†æœºåˆ¶

2. **å·¥å…·æ³¨å†Œä¿®å¤** (EPIC-007 Core):
   - ä¿®å¤MCPå·¥å…·æ³¨å†Œç¼ºå¤±é—®é¢˜
   - å®ç°15ä¸ªçœŸå®å·¥å…·çš„æ™ºèƒ½æ³¨å†Œ
   - å·¥å…·åˆ†ç±»å’Œä¸­æ–‡æ˜¾ç¤ºç•Œé¢

3. **ç”¨æˆ·ä½“éªŒæå‡**:
   - è¯¦ç»†çš„å·¥å…·åˆ—è¡¨æ˜¾ç¤º
   - ä¸­æ–‡å‹å¥½çš„äº¤äº’ç•Œé¢
   - å®æ—¶çš„æ‰§è¡ŒçŠ¶æ€è·Ÿè¸ª

### 6.2 å¾…éªŒè¯é¡¹ç›® âš ï¸

1. **å®é™…å·¥å…·æ‰§è¡Œ**: éªŒè¯ä»æ¨ç†åˆ°MCPå·¥å…·æ‰§è¡Œçš„å®Œæ•´é“¾æ¡
2. **æ¨ç†å¼•æ“ä¼˜åŒ–**: ç¡®ä¿ReasoningEngineæ­£ç¡®é€‰æ‹©å’Œè°ƒç”¨MCPå·¥å…·
3. **æ€§èƒ½æµ‹è¯•**: éªŒè¯ç®€åŒ–åçš„æ¶æ„æ€§èƒ½å’Œç¨³å®šæ€§

### 6.3 å¯é€‰ä¼˜åŒ–é¡¹ç›® ğŸ”§

1. **è¿›ä¸€æ­¥æ¶æ„ç®€åŒ–**:
   - å‡å°‘AgentåŒ…è£…å±‚æ¬¡
   - ç»„ä»¶å•ä¾‹åŒ–å’ŒçŠ¶æ€å¤ç”¨
   - é…ç½®ç³»ç»Ÿè¿›ä¸€æ­¥ç®€åŒ–

2. **åŠŸèƒ½å¢å¼º**:
   - æ›´å¤šMCPå·¥å…·é›†æˆ
   - é«˜çº§ReActç­–ç•¥
   - æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–

## 7. æŠ€æœ¯æ ˆä¸ä¾èµ–

### 7.1 æ ¸å¿ƒä¾èµ–
- **Python 3.11+**: ç°ä»£Pythonç‰¹æ€§æ”¯æŒ
- **OpenAI Agents SDK**: æ™ºèƒ½ä»£ç†æ ¸å¿ƒå¼•æ“
- **MCP Protocol**: å·¥å…·é›†æˆæ ‡å‡†åè®®
- **LiteLLM**: å¤šæ¨¡å‹LLMè·¯ç”±æ”¯æŒ
- **Pydantic**: é…ç½®éªŒè¯å’Œæ•°æ®æ¨¡å‹

### 7.2 MCPå·¥å…·ç”Ÿæ€ç³»ç»Ÿ
- **filesystem**: å®Œæ•´çš„æ–‡ä»¶ç³»ç»Ÿæ“ä½œå·¥å…·é›†
- **my-search**: ç½‘ç»œæœç´¢å’Œä¿¡æ¯è·å–å·¥å…·
- **æ‰©å±•æ€§**: æ”¯æŒæ·»åŠ æ›´å¤šç¬¬ä¸‰æ–¹MCPæœåŠ¡å™¨

---

**è®¾è®¡æ–‡æ¡£æ€»ç»“**: TinyAgent v1.3 å®ç°äº†ä»å¤æ‚å¤šæ¨¡å¼æ¶æ„åˆ°ç®€åŒ–å•ä¸€æ™ºèƒ½æ¨¡å¼çš„é‡å¤§è½¬å˜ï¼Œä¸“æ³¨äºæä¾›çœŸå®ã€é€æ˜ã€ä¸­æ–‡å‹å¥½çš„AIä»£ç†ä½“éªŒã€‚é€šè¿‡ç§»é™¤ä¸å¿…è¦çš„å¤æ‚æ€§å’Œä¿®å¤å…³é”®çš„å·¥å…·æ³¨å†Œé—®é¢˜ï¼ŒTinyAgentç°åœ¨æ˜¯ä¸€ä¸ªçœŸæ­£ç®€æ´è€Œå¼ºå¤§çš„æ™ºèƒ½ä»£ç†æ¡†æ¶ã€‚

## 8. ä»£ç ç»„ç»‡ç»“æ„

```
TinyAgent/
â”œâ”€â”€ tinyagent/                      # ä¸»è¦åŒ…ç›®å½•
â”‚   â”œâ”€â”€ __init__.py                 # åŒ…åˆå§‹åŒ–
â”‚   â”œâ”€â”€ core/                       # æ ¸å¿ƒæ¨¡å—
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ agent.py               # ä¸»è¦Agentç±»
â”‚   â”‚   â””â”€â”€ config.py              # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ mcp/                       # MCPé›†æˆ
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ manager.py             # MCPæœåŠ¡å™¨ç®¡ç†
â”‚   â”œâ”€â”€ llm/                       # LLMæä¾›å•†ï¼ˆé¢„ç•™ï¼‰
â”‚   â”‚   â””â”€â”€ __init__.py
â”‚   â”œâ”€â”€ cli/                       # å‘½ä»¤è¡Œç•Œé¢
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ main.py                # CLIå®ç°
â”‚   â”œâ”€â”€ configs/                   # é…ç½®æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ defaults/              # é»˜è®¤é…ç½®
â”‚   â”‚   â”‚   â”œâ”€â”€ agent.yaml
â”‚   â”‚   â”‚   â”œâ”€â”€ llm_providers.yaml
â”‚   â”‚   â”‚   â””â”€â”€ mcp_servers.yaml
â”‚   â”‚   â”œâ”€â”€ profiles/              # é…ç½®æ–‡ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ development.yaml
â”‚   â”‚   â”‚   â”œâ”€â”€ production.yaml
â”‚   â”‚   â”‚   â””â”€â”€ openrouter.yaml
â”‚   â”‚   â””â”€â”€ config/                # ç”¨æˆ·é…ç½®ï¼ˆå¯é€‰ï¼‰
â”‚   â””â”€â”€ prompts/                   # æç¤ºè¯æ¨¡æ¿
â”‚       â”œâ”€â”€ default_instructions.txt
â”‚       â”œâ”€â”€ prd_generator.txt
â”‚       â””â”€â”€ system_design.txt
â”œâ”€â”€ memory-bank/                   # é¡¹ç›®è®°å¿†åº“
â”‚   â”œâ”€â”€ projectbrief.md
â”‚   â”œâ”€â”€ systemPatterns.md
â”‚   â”œâ”€â”€ progress.md
â”‚   â”œâ”€â”€ activeContext.md
â”‚   â””â”€â”€ TinyAgent_PRD_v1.0.md
â”œâ”€â”€ tests/                         # æµ‹è¯•æ–‡ä»¶
â”‚   â”œâ”€â”€ test_agent.py
â”‚   â”œâ”€â”€ test_config.py
â”‚   â””â”€â”€ test_mcp.py
â”œâ”€â”€ .env                          # ç¯å¢ƒå˜é‡é…ç½®
â”œâ”€â”€ .gitignore
â”œâ”€â”€ requirements.txt              # Pythonä¾èµ–
â”œâ”€â”€ setup.py                      # å®‰è£…é…ç½®
â””â”€â”€ README.md                     # é¡¹ç›®æ–‡æ¡£
```

## 9. æ ¸å¿ƒä¾èµ–

### 9.1 ä¸»è¦ä¾èµ–åŒ…
```python
# æ ¸å¿ƒæ¡†æ¶
openai-agents[litellm]>=0.0.16      # Agent SDK + LiteLLMæ”¯æŒ
python-dotenv>=1.0.0                # ç¯å¢ƒå˜é‡ç®¡ç†
pyyaml>=6.0                         # YAMLé…ç½®æ–‡ä»¶
click>=8.0.0                        # CLIæ¡†æ¶

# LLMæ”¯æŒ
litellm>=1.0.0                      # å¤šæ¨¡å‹LLMæ”¯æŒ
openai>=1.0.0                       # OpenAI APIå®¢æˆ·ç«¯

# MCPæ”¯æŒ
# (åŒ…å«åœ¨openai-agentsä¸­)

# å¼€å‘å·¥å…·
pytest>=7.0.0                      # æµ‹è¯•æ¡†æ¶
black>=23.0.0                       # ä»£ç æ ¼å¼åŒ–
mypy>=1.0.0                         # ç±»å‹æ£€æŸ¥
flake8>=6.0.0                       # ä»£ç æ£€æŸ¥
```

### 9.2 MCPæœåŠ¡å™¨ä¾èµ–
```bash
# Node.js MCPæœåŠ¡å™¨
npm install -g @modelcontextprotocol/server-filesystem
npm install -g @modelcontextprotocol/server-fetch

# æˆ–æœ¬åœ°æ„å»º
# è‡ªå®šä¹‰MCPæœåŠ¡å™¨åœ¨ç›¸åº”ç›®å½•
```

## 10. ä½¿ç”¨æŒ‡å—

### 10.1 å¿«é€Ÿå¼€å§‹

#### 1. å®‰è£…å’Œé…ç½®
```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/your-org/TinyAgent
cd TinyAgent

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python -m venv .venv
.venv\Scripts\activate  # Windows
# æˆ– source .venv/bin/activate  # Linux/Mac

# å®‰è£…ä¾èµ–
uv pip install -e .

# é…ç½®ç¯å¢ƒå˜é‡
cp .env.template .env
# ç¼–è¾‘.envæ–‡ä»¶ï¼Œè®¾ç½®APIå¯†é’¥
echo "OPENROUTER_API_KEY=your-key-here" >> .env
```

#### 2. åŸºç¡€ä½¿ç”¨
```bash
# æ£€æŸ¥é…ç½®çŠ¶æ€
python -m tinyagent status

# è¿è¡Œç®€å•ä»»åŠ¡
python -m tinyagent run "è¯·å¸®æˆ‘åˆ†æè¿™ä¸ªé¡¹ç›®çš„ç»“æ„"

# ç”ŸæˆPRDæ–‡æ¡£
python -m tinyagent generate prd "AIèŠå¤©æœºå™¨äººé¡¹ç›®"

# äº¤äº’æ¨¡å¼
python -m tinyagent interactive
```

### 10.2 é«˜çº§ä½¿ç”¨

#### 1. ä½¿ç”¨ä¸åŒæ¨¡å‹
```bash
# ä½¿ç”¨Google Gemini
python -m tinyagent run "åˆ†æéœ€æ±‚" --model "google/gemini-2.0-flash-001"

# ä½¿ç”¨Anthropic Claude
python -m tinyagent run "è®¾è®¡ç³»ç»Ÿ" --model "anthropic/claude-3.5-sonnet"
```

#### 2. é…ç½®æ–‡ä»¶ç®¡ç†
```bash
# ä½¿ç”¨ç”Ÿäº§é…ç½®æ–‡ä»¶
python -m tinyagent --profile production status

# åˆ—å‡ºå¯ç”¨é…ç½®æ–‡ä»¶
python -m tinyagent list-profiles

# æŸ¥çœ‹MCPæœåŠ¡å™¨çŠ¶æ€
python -m tinyagent list-servers
```

#### 3. è‡ªå®šä¹‰é…ç½®
```yaml
# configs/config/agent.yaml - ç”¨æˆ·è‡ªå®šä¹‰é…ç½®
agent:
  name: "MyCustomAgent"
  max_iterations: 20

llm:
  model: "deepseek/deepseek-chat-v3-0324"
  temperature: 0.8

mcp:
  servers:
    filesystem:
      enabled: true
    custom_server:
      enabled: true
      type: "stdio"
      command: "python"
      args: ["my_custom_server.py"]
```

### 10.3 å¼€å‘æ‰©å±•

#### 1. æ·»åŠ æ–°çš„MCPå·¥å…·
```yaml
# configs/profiles/development.yaml
mcp:
  servers:
    my_tool:
      enabled: true
      type: "stdio"
      command: "node"
      args: ["./my-mcp-server.js"]
      description: "è‡ªå®šä¹‰å·¥å…·æœåŠ¡å™¨"
      category: "custom_tools"
```

#### 2. åˆ›å»ºè‡ªå®šä¹‰æç¤ºè¯
```txt
# prompts/custom_task.txt
ä½ æ˜¯ä¸€ä¸ªä¸“é—¨å¤„ç†{task_type}çš„æ™ºèƒ½åŠ©æ‰‹ã€‚

è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ‰§è¡Œä»»åŠ¡ï¼š
1. åˆ†æè¾“å…¥å†…å®¹
2. åˆ¶å®šæ‰§è¡Œè®¡åˆ’
3. ä½¿ç”¨åˆé€‚çš„å·¥å…·
4. æ•´ç†å’Œè¾“å‡ºç»“æœ

è¯·ç¡®ä¿è¾“å‡ºæ ¼å¼æ¸…æ™°ï¼Œå†…å®¹å‡†ç¡®ã€‚
```

## 11. æŠ€æœ¯ç‰¹æ€§

### 11.1 æ€§èƒ½ç‰¹æ€§
- **å¼‚æ­¥æ‰§è¡Œ**ï¼šå®Œå…¨å¼‚æ­¥çš„MCPæœåŠ¡å™¨è¿æ¥å’Œå·¥å…·è°ƒç”¨
- **è¿æ¥æ± ç®¡ç†**ï¼šé«˜æ•ˆçš„èµ„æºå¤ç”¨å’Œè¿æ¥ç®¡ç†
- **è‡ªåŠ¨é‡è¯•**ï¼šç½‘ç»œè¯·æ±‚å’ŒæœåŠ¡è¿æ¥çš„è‡ªåŠ¨é‡è¯•æœºåˆ¶
- **é”™è¯¯æ¢å¤**ï¼šæœåŠ¡å™¨æ•…éšœæ—¶çš„ä¼˜é›…é™çº§

### 11.2 å®‰å…¨ç‰¹æ€§
- **å‡­è¯éš”ç¦»**ï¼šAPIå¯†é’¥é€šè¿‡ç¯å¢ƒå˜é‡å®‰å…¨ç®¡ç†
- **æƒé™æ§åˆ¶**ï¼šMCPå·¥å…·çš„è®¿é—®æƒé™æ§åˆ¶
- **æ•°æ®éšç§**ï¼šæœ¬åœ°å¤„ç†ä¼˜å…ˆï¼Œæœ€å°åŒ–æ•°æ®ä¼ è¾“
- **å®¡è®¡æ—¥å¿—**ï¼šå®Œæ•´çš„æ“ä½œæ—¥å¿—è®°å½•

### 11.3 æ‰©å±•æ€§ç‰¹æ€§
- **æ’ä»¶æ¶æ„**ï¼šæ”¯æŒè‡ªå®šä¹‰MCPæœåŠ¡å™¨å¼€å‘
- **æ¨¡å‹æ— å…³**ï¼šæ”¯æŒä»»æ„LLMæ¨¡å‹çš„æ— ç¼åˆ‡æ¢
- **é…ç½®é©±åŠ¨**ï¼šæ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½é€šè¿‡é…ç½®æ–‡ä»¶æ§åˆ¶
- **APIæ¥å£**ï¼šæä¾›ç¼–ç¨‹æ¥å£ç”¨äºé›†æˆå¼€å‘

## 12. é¡¹ç›®çŠ¶æ€

### å½“å‰ç‰ˆæœ¬: v0.1.0 (Phase 3å®Œæˆ)
- âœ… **æ ¸å¿ƒAgentæ¡†æ¶** - å®Œå…¨å®ç°
- âœ… **å¤šæ¨¡å‹LLMæ”¯æŒ** - 100+ æ¨¡å‹æ”¯æŒ 
- âœ… **MCPå·¥å…·é›†æˆ** - æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œè¯·æ±‚ã€é¡ºåºæ€è€ƒç­‰
- âœ… **é…ç½®ç®¡ç†ç³»ç»Ÿ** - ç”Ÿäº§çº§åˆ†å±‚é…ç½®
- âœ… **CLIç”¨æˆ·ç•Œé¢** - å®Œæ•´å‘½ä»¤é›†

### ä¸‹ä¸€é˜¶æ®µè§„åˆ’ (Phase 4)
- ğŸ”§ **é«˜çº§MCPå·¥å…·** - æ•°æ®åº“ã€ä»£ç åˆ†æç­‰å·¥å…·
- ğŸ”§ **æ€§èƒ½ä¼˜åŒ–** - è¿æ¥æ± ã€ç¼“å­˜ã€ç›‘æ§
- ğŸ”§ **ä¼ä¸šç‰¹æ€§** - RBACã€å®¡è®¡ã€å¤šç§Ÿæˆ·
- ğŸ”§ **Webç•Œé¢** - å¯é€‰çš„å›¾å½¢åŒ–ç®¡ç†ç•Œé¢

---

*æœ¬è®¾è®¡æ–‡æ¡£åŸºäºTinyAgentå½“å‰æ¶æ„å’Œå®ç°çŠ¶æ€ç¼–å†™ï¼Œå°†éšé¡¹ç›®å‘å±•æŒç»­æ›´æ–°ã€‚* 

## 13. ğŸš¨ **Critical Intelligence Gap Analysis & Fix Epic**
*Added: 2025-06-02*  
*Priority: CRITICAL*  
*Epic Status: COMPLETED âœ…*

### 13.1 Critical Issue Identification

**é—®é¢˜**: TinyAgentè™½ç„¶æŠ€æœ¯æ ˆå®Œå–„ï¼ˆå¤šæ¨¡å‹LLMæ”¯æŒã€MCPå·¥å…·é›†æˆã€é…ç½®ç®¡ç†ç­‰ï¼‰ï¼Œä½†ç¼ºå°‘æ ¸å¿ƒæ™ºèƒ½èƒ½åŠ›ï¼Œè¡¨ç°ä¸ºï¼š
- ğŸš« **æ— ReActå¾ªç¯**: ç¼ºå°‘æ¨ç†â†’è¡ŒåŠ¨â†’è§‚å¯Ÿçš„æ™ºèƒ½å†³ç­–å¾ªç¯
- ğŸš« **æ— å·¥å…·æ™ºèƒ½**: ä¸çŸ¥é“ä½•æ—¶å’Œå¦‚ä½•ä½¿ç”¨å·²é›†æˆçš„MCPå·¥å…·
- ğŸš« **æ— å¯¹è¯è®°å¿†**: æ— æ³•ç»´æŠ¤å¯¹è¯å†å²å’Œä¸Šä¸‹æ–‡
- ğŸš« **æ— ä»»åŠ¡è§„åˆ’**: æ— æ³•åˆ†è§£å¤æ‚ä»»åŠ¡ä¸ºå¯æ‰§è¡Œæ­¥éª¤
- ğŸš« **æ— è‡ªä¸»æ‰§è¡Œ**: åªæ˜¯è¢«åŠ¨å›å¤ï¼Œæ²¡æœ‰ä¸»åŠ¨æ‰§è¡Œèƒ½åŠ›

### 13.2 Root Cause Analysis

#### å½“å‰æ¶æ„é—®é¢˜:
```python
# å½“å‰å®ç° (é—®é¢˜):
async def run(self, message: str, **kwargs) -> Any:
    # ç›´æ¥è°ƒç”¨LLMï¼Œæ²¡æœ‰æ™ºèƒ½å¾ªç¯
    result = await Runner.run(starting_agent=agent, input=message, **kwargs)
    return result  # ä¸€æ¬¡æ€§è¿”å›ï¼Œæ— è¿­ä»£æ¨ç†
```

#### ç¼ºå¤±çš„æ™ºèƒ½å±‚:
```mermaid
graph TD
    CurrentFlow[å½“å‰æµç¨‹: ç”¨æˆ·è¾“å…¥ â†’ LLM â†’ ç›´æ¥è¾“å‡º]
    
    MissingFlow[ç¼ºå¤±çš„æ™ºèƒ½æµç¨‹:]
    MissingFlow --> TaskAnalysis[ä»»åŠ¡åˆ†æ]
    TaskAnalysis --> Planning[è§„åˆ’åˆ¶å®š]
    Planning --> ReActLoop{ReActå¾ªç¯}
    ReActLoop --> |æ¨ç†| Reasoning[åˆ†æå½“å‰çŠ¶æ€]
    Reasoning --> |è¡ŒåŠ¨| Action[é€‰æ‹©å¹¶æ‰§è¡Œå·¥å…·]
    Action --> |è§‚å¯Ÿ| Observation[è¯„ä¼°æ‰§è¡Œç»“æœ]
    Observation --> |ç»§ç»­?| ReActLoop
    ReActLoop --> |å®Œæˆ| FinalOutput[æœ€ç»ˆè¾“å‡º]
    
    class CurrentFlow problemClass
    class MissingFlow solutionClass
```

### 13.3 Intelligence Architecture Design

#### æ–°çš„æ™ºèƒ½ä»£ç†æ¶æ„:
```python
class IntelligentAgent:
    """æ™ºèƒ½ä»£ç†æ ¸å¿ƒç±» - å®ç°å®Œæ•´ReActå¾ªç¯"""
    
    def __init__(self, llm, tools, memory, planner):
        self.llm = llm                    # LLMæ¨ç†å¼•æ“
        self.tools = tools                # MCPå·¥å…·ç®¡ç†å™¨
        self.memory = memory              # å¯¹è¯å’Œä»»åŠ¡è®°å¿†
        self.planner = planner            # ä»»åŠ¡è§„åˆ’å™¨
        self.max_iterations = 10          # é˜²æ­¢æ— é™å¾ªç¯
    
    async def execute_task(self, user_input: str) -> str:
        """æ‰§è¡Œå®Œæ•´çš„æ™ºèƒ½ä»»åŠ¡æµç¨‹"""
        # 1. ä»»åŠ¡åˆ†æå’Œè§„åˆ’
        task_plan = await self.planner.analyze_and_plan(user_input)
        
        # 2. ReActå¾ªç¯æ‰§è¡Œ
        for iteration in range(self.max_iterations):
            # æ¨ç† (Reasoning)
            reasoning = await self.reason_about_current_state(task_plan)
            
            if reasoning.is_complete:
                break
                
            # è¡ŒåŠ¨ (Acting)
            action_result = await self.take_action(reasoning.next_action)
            
            # è§‚å¯Ÿ (Observation)
            observation = await self.observe_results(action_result)
            
            # æ›´æ–°ä»»åŠ¡çŠ¶æ€
            task_plan.update_with_observation(observation)
        
        # 3. æ•´åˆæœ€ç»ˆç»“æœ
        return await self.synthesize_final_result(task_plan)
```

#### æ ¸å¿ƒç»„ä»¶è®¾è®¡:

1. **TaskPlanner** - ä»»åŠ¡è§„åˆ’å™¨
```python
class TaskPlanner:
    async def analyze_and_plan(self, user_input: str) -> TaskPlan:
        """åˆ†æç”¨æˆ·éœ€æ±‚å¹¶åˆ¶å®šæ‰§è¡Œè®¡åˆ’"""
        
    def identify_required_tools(self, task: str) -> List[str]:
        """è¯†åˆ«ä»»åŠ¡æ‰€éœ€çš„å·¥å…·"""
        
    def decompose_into_steps(self, task: str) -> List[TaskStep]:
        """å°†å¤æ‚ä»»åŠ¡åˆ†è§£ä¸ºæ­¥éª¤"""
```

2. **ConversationMemory** - å¯¹è¯è®°å¿†
```python
class ConversationMemory:
    def __init__(self):
        self.conversation_history = []
        self.task_context = {}
        self.tool_usage_history = []
    
    def add_exchange(self, user_input: str, agent_response: str):
        """æ·»åŠ å¯¹è¯è®°å½•"""
    
    def get_relevant_context(self, current_input: str) -> str:
        """è·å–ç›¸å…³ä¸Šä¸‹æ–‡"""
```

3. **ToolSelector** - å·¥å…·é€‰æ‹©å™¨
```python
class ToolSelector:
    def __init__(self, available_tools: Dict[str, Any]):
        self.tools = available_tools
        
    async def select_best_tool(self, task_step: TaskStep) -> str:
        """åŸºäºä»»åŠ¡æ­¥éª¤é€‰æ‹©æœ€åˆé€‚çš„å·¥å…·"""
        
    def can_handle_task(self, tool_name: str, task: str) -> bool:
        """åˆ¤æ–­å·¥å…·æ˜¯å¦èƒ½å¤„ç†ç‰¹å®šä»»åŠ¡"""
```

### 13.4 Implementation Epic

#### **Epic: TinyAgent Intelligence Implementation**
**Epic ID**: EPIC-001  
**Priority**: P0 (Critical)  
**Estimated Effort**: 2-3 weeks  
**Dependencies**: Current MCP integration, LLM provider system

#### Phase 1: Core Intelligence Framework (Week 1)
- **Story 1.1**: å®ç°TaskPlannerç»„ä»¶
  - ä»»åŠ¡åˆ†æå’Œåˆ†è§£é€»è¾‘
  - å·¥å…·éœ€æ±‚è¯†åˆ«
  - æ‰§è¡Œæ­¥éª¤è§„åˆ’
  
- **Story 1.2**: å®ç°ConversationMemoryç»„ä»¶
  - å¯¹è¯å†å²ç®¡ç†
  - ä¸Šä¸‹æ–‡ç›¸å…³æ€§è®¡ç®—
  - ä»»åŠ¡çŠ¶æ€è·Ÿè¸ª
  
- **Story 1.3**: å®ç°ToolSelectorç»„ä»¶
  - åŸºäºä»»åŠ¡çš„å·¥å…·é€‰æ‹©é€»è¾‘
  - å·¥å…·èƒ½åŠ›æ˜ å°„
  - æ‰§è¡Œç»“æœè¯„ä¼°

#### Phase 2: ReAct Loop Implementation (Week 2)
- **Story 2.1**: å®ç°æ¨ç†å¼•æ“ (Reasoning)
  - å½“å‰çŠ¶æ€åˆ†æ
  - ä¸‹ä¸€æ­¥è¡ŒåŠ¨å†³ç­–
  - å®ŒæˆçŠ¶æ€åˆ¤æ–­
  
- **Story 2.2**: å®ç°è¡ŒåŠ¨æ‰§è¡Œå™¨ (Acting)
  - å·¥å…·è°ƒç”¨ç®¡ç†
  - å‚æ•°æ™ºèƒ½ç”Ÿæˆ
  - æ‰§è¡ŒçŠ¶æ€ç›‘æ§
  
- **Story 2.3**: å®ç°è§‚å¯Ÿå™¨ (Observation)
  - ç»“æœè´¨é‡è¯„ä¼°
  - é”™è¯¯æ£€æµ‹å’Œå¤„ç†
  - è¿›åº¦æ›´æ–°

#### Phase 3: Integration & Testing (Week 3)
- **Story 3.1**: é›†æˆæ–°æ™ºèƒ½æ¶æ„åˆ°ç°æœ‰TinyAgent
  - ä¿æŒå‘åå…¼å®¹
  - é…ç½®ç³»ç»Ÿé›†æˆ
  - é”™è¯¯å¤„ç†æ”¹è¿›
  
- **Story 3.2**: ç«¯åˆ°ç«¯æµ‹è¯•å’Œä¼˜åŒ–
  - å¤æ‚ä»»åŠ¡æµ‹è¯•åœºæ™¯
  - æ€§èƒ½ä¼˜åŒ–
  - ç”¨æˆ·ä½“éªŒæ”¹è¿›

### 13.5 Success Metrics

#### æ ¸å¿ƒèƒ½åŠ›æŒ‡æ ‡:
- âœ… **ä»»åŠ¡å®Œæˆç‡**: å¤æ‚ä»»åŠ¡çš„æˆåŠŸå®Œæˆæ¯”ä¾‹ (ç›®æ ‡: >80%)
- âœ… **å·¥å…·ä½¿ç”¨æ™ºèƒ½**: æ­£ç¡®é€‰æ‹©å’Œä½¿ç”¨å·¥å…·çš„æ¯”ä¾‹ (ç›®æ ‡: >90%)
- âœ… **å¯¹è¯è¿è´¯æ€§**: å¤šè½®å¯¹è¯çš„ä¸Šä¸‹æ–‡ä¿æŒèƒ½åŠ› (ç›®æ ‡: >85%)
- âœ… **ä»»åŠ¡åˆ†è§£å‡†ç¡®æ€§**: å¤æ‚ä»»åŠ¡æ­£ç¡®åˆ†è§£çš„æ¯”ä¾‹ (ç›®æ ‡: >75%)

#### ç”¨æˆ·ä½“éªŒæŒ‡æ ‡:
- âœ… **å“åº”è´¨é‡**: ç”¨æˆ·æ»¡æ„åº¦è¯„åˆ† (ç›®æ ‡: >4.0/5.0)
- âœ… **æ‰§è¡Œæ•ˆç‡**: å¹³å‡ä»»åŠ¡å®Œæˆæ—¶é—´ (ç›®æ ‡: <2åˆ†é’Ÿ)
- âœ… **é”™è¯¯æ¢å¤**: é”™è¯¯åçš„è‡ªåŠ¨æ¢å¤èƒ½åŠ› (ç›®æ ‡: >70%)

### 13.6 Technical Implementation Plan

#### æ–‡ä»¶ç»“æ„æ›´æ–°:
```
tinyagent/
â”œâ”€â”€ intelligence/              # æ–°å¢æ™ºèƒ½æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ planner.py            # ä»»åŠ¡è§„åˆ’å™¨
â”‚   â”œâ”€â”€ memory.py             # å¯¹è¯è®°å¿†
â”‚   â”œâ”€â”€ reasoner.py           # æ¨ç†å¼•æ“
â”‚   â”œâ”€â”€ actor.py              # è¡ŒåŠ¨æ‰§è¡Œå™¨
â”‚   â”œâ”€â”€ observer.py           # è§‚å¯Ÿå™¨
â”‚   â””â”€â”€ selector.py           # å·¥å…·é€‰æ‹©å™¨
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ agent.py              # å¢å¼ºç°æœ‰Agentç±»
â”‚   â””â”€â”€ intelligent_agent.py  # æ–°çš„æ™ºèƒ½ä»£ç†ç±»
â””â”€â”€ prompts/
    â”œâ”€â”€ reasoning_prompts.txt  # æ¨ç†æç¤ºè¯
    â”œâ”€â”€ planning_prompts.txt   # è§„åˆ’æç¤ºè¯
    â””â”€â”€ reflection_prompts.txt # åæ€æç¤ºè¯
```

#### é…ç½®å¢å¼º:
```yaml
# configs/profiles/development.yaml
intelligence:
  enabled: true
  max_iterations: 10
  reasoning_depth: 3
  memory_retention: 100  # ä¿ç•™æœ€è¿‘100è½®å¯¹è¯
  
  planner:
    decomposition_strategy: "hierarchical"
    tool_selection_strategy: "capability_based"
  
  memory:
    context_window: 50
    relevance_threshold: 0.7
```

### 13.7 Risk Mitigation

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| æ¨ç†å¾ªç¯æ— é™è¿­ä»£ | ä¸­ | é«˜ | å®ç°æœ€å¤§è¿­ä»£é™åˆ¶å’Œæ™ºèƒ½ç»ˆæ­¢æ¡ä»¶ |
| å·¥å…·é€‰æ‹©é”™è¯¯ | ä¸­ | ä¸­ | å¤šå±‚éªŒè¯å’Œå›é€€æœºåˆ¶ |
| æ€§èƒ½å½±å“ | é«˜ | ä¸­ | å¼‚æ­¥æ‰§è¡Œå’Œç¼“å­˜ä¼˜åŒ– |
| å‘åå…¼å®¹æ€§ç ´å | ä½ | é«˜ | ä¿æŒç°æœ‰APIï¼Œæ–°åŠŸèƒ½å¯é€‰å¯ç”¨ |

### 13.8 Next Steps

1. **ç«‹å³è¡ŒåŠ¨** (æœ¬å‘¨):
   - åˆ›å»ºintelligenceæ¨¡å—æ¡†æ¶
   - å®ç°åŸºç¡€TaskPlannerç±»
   - ç¼–å†™æ¨ç†æç¤ºè¯æ¨¡æ¿

2. **çŸ­æœŸç›®æ ‡** (2å‘¨å†…):
   - å®ŒæˆPhase 1å’ŒPhase 2å¼€å‘
   - å®ç°åŸºæœ¬çš„ReActå¾ªç¯

3. **ä¸­æœŸç›®æ ‡** (1æœˆå†…):
   - å®Œæˆå®Œæ•´æ™ºèƒ½æ¶æ„é›†æˆ
   - é€šè¿‡æ‰€æœ‰æ ¸å¿ƒèƒ½åŠ›æµ‹è¯•

**è¿™ä¸ªEpicå°†å½»åº•è§£å†³TinyAgentçš„æ™ºèƒ½ç¼ºå¤±é—®é¢˜ï¼Œå°†å…¶ä»ç®€å•çš„LLMåŒ…è£…å™¨è½¬å˜ä¸ºçœŸæ­£çš„æ™ºèƒ½ä»£ç†ã€‚**

---

*è¿™ä¸ªEpicå’Œå®æ–½è®¡åˆ’è§£å†³äº†TinyAgentæœ€å…³é”®çš„æ¶æ„ç¼ºé™·ï¼Œæ˜¯é¡¹ç›®æˆåŠŸçš„å…³é”®é‡Œç¨‹ç¢‘ã€‚* 

## 14. ğŸ”§ **EPIC-002: MCP Tools Enhancement & Caching System**
*Added: 2025-06-02*  
*Priority: HIGH*  
*Epic Status: IN PROGRESS*

### 14.1 Epic Overview

**Epic ID**: EPIC-002  
**Priority**: P1 (High)  
**Estimated Effort**: 1-2 weeks  
**Dependencies**: EPIC-001 (Intelligence Framework), Current MCP Integration

**é—®é¢˜æè¿°**: å½“å‰TinyAgentè™½ç„¶å…·å¤‡MCPå·¥å…·é›†æˆå’Œæ™ºèƒ½æ¨¡å¼ï¼Œä½†ç¼ºå°‘å·¥å…·å¯è§æ€§ã€ç¼“å­˜æœºåˆ¶å’Œä¸Šä¸‹æ–‡æ„ŸçŸ¥åŠŸèƒ½ï¼š
- ğŸ” **å·¥å…·å¯è§æ€§ç¼ºå¤±**: ç”¨æˆ·æ— æ³•æŸ¥çœ‹æ¯ä¸ªMCPæœåŠ¡å™¨æä¾›çš„å…·ä½“å·¥å…·åˆ—è¡¨
- ğŸ§  **Agentå·¥å…·æ„ŸçŸ¥ä¸è¶³**: Agentæ— æ³•å°†å¯ç”¨çš„MCPå·¥å…·æ·»åŠ åˆ°è‡ªå·±çš„ä¸Šä¸‹æ–‡ä¸­è¿›è¡Œæ™ºèƒ½é€‰æ‹©
- âš¡ **æ€§èƒ½ä¼˜åŒ–ç¼ºå¤±**: æ¯æ¬¡éƒ½é‡æ–°è¿æ¥å’ŒæŸ¥è¯¢MCPæœåŠ¡å™¨ï¼Œç¼ºå°‘ç¼“å­˜æœºåˆ¶
- ğŸ“Š **å·¥å…·çŠ¶æ€ä¸å¯è§**: æ— æ³•æŸ¥çœ‹å·¥å…·çš„å¯ç”¨æ€§ã€æ€§èƒ½ç»Ÿè®¡ç­‰çŠ¶æ€ä¿¡æ¯

### 14.2 User Requirements Analysis

**ç”¨æˆ·éœ€æ±‚1**: å‚æ•°åŒ–æ˜¾ç¤ºå·¥å…·åˆ—è¡¨
```bash
# æœŸæœ›çš„ç”¨æˆ·ä½“éªŒ
python -m tinyagent list-servers --show-tools
[OK] filesystem
   Type: stdio
   Tools: read_file, write_file, create_directory, list_directory, search_files, get_file_info
   
[OK] sequential-thinking  
   Type: stdio
   Tools: sequentialthinking
   
[OK] my-search
   Type: sse
   Tools: search_web, get_page_content
```

**ç”¨æˆ·éœ€æ±‚2**: Agentä¸Šä¸‹æ–‡æ„ŸçŸ¥
```python
# Agentåº”è¯¥èƒ½å¤Ÿæ„ŸçŸ¥å’Œæè¿°è‡ªå·±çš„å·¥å…·èƒ½åŠ›
agent = TinyAgent()
tools_context = agent.get_tools_context()
# Agentåœ¨å¤„ç†ä»»åŠ¡æ—¶ï¼Œè‡ªåŠ¨å°†å·¥å…·ä¿¡æ¯åŠ å…¥ä¸Šä¸‹æ–‡ï¼Œè€Œä¸æ˜¯ç³»ç»Ÿæç¤º
```

**ç”¨æˆ·éœ€æ±‚3**: ç¼“å­˜å’Œæ€§èƒ½ä¼˜åŒ–
```python
# ä¸€æ¬¡æ€§åˆå§‹åŒ–ï¼Œå¤šæ¬¡å¤ç”¨
agent = TinyAgent()
# ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼šè¿æ¥æœåŠ¡å™¨å¹¶ç¼“å­˜å·¥å…·ä¿¡æ¯
tools = agent.get_available_tools_cached()  # è¿æ¥+ç¼“å­˜
# åç»­è°ƒç”¨ï¼šç›´æ¥ä½¿ç”¨ç¼“å­˜
tools = agent.get_available_tools_cached()  # ä»…ä½¿ç”¨ç¼“å­˜
```

### 14.3 Technical Architecture Design

#### æ–°çš„MCPå·¥å…·ç¼“å­˜æ¶æ„:
```mermaid
graph TB
    subgraph "Enhanced MCP Architecture"
        MCPManager[MCP Manager] --> ToolCache[Tool Cache]
        MCPManager --> ServerConnPool[Server Connection Pool]
        
        ToolCache --> ToolMetadata[Tool Metadata Store]
        ToolCache --> ServerStatus[Server Status Cache]
        ToolCache --> PerformanceMetrics[Performance Metrics]
        
        ServerConnPool --> FileSystemServer[FileSystem Server]
        ServerConnPool --> FetchServer[Fetch Server]
        ServerConnPool --> ThinkingServer[Sequential Thinking]
        ServerConnPool --> SearchServer[Search Server]
        
        IntelligentAgent --> ContextBuilder[Context Builder]
        ContextBuilder --> ToolCache
        ContextBuilder --> AgentContext[Agent Tool Context]
    end
    
    subgraph "CLI Enhancement"
        ListServersCmd[list-servers --show-tools]
        ListServersCmd --> MCPManager
        
        StatusCmd[status --tools]
        StatusCmd --> ToolCache
    end
    
    subgraph "Agent Integration"
        TinyAgent --> IntelligentAgent
        TinyAgent --> MCPManager
        IntelligentAgent --> ToolSelector
        ToolSelector --> ToolCache
    end
```

#### æ ¸å¿ƒç»„ä»¶è®¾è®¡:

1. **Enhanced MCPServerManager** - å¢å¼ºçš„MCPæœåŠ¡å™¨ç®¡ç†å™¨
```python
class EnhancedMCPServerManager:
    def __init__(self):
        self.tool_cache = MCPToolCache()
        self.connection_pool = MCPConnectionPool()
        self.performance_tracker = PerformanceTracker()
    
    async def initialize_with_caching(self) -> Dict[str, List[ToolInfo]]:
        """åˆå§‹åŒ–æœåŠ¡å™¨å¹¶ç¼“å­˜å·¥å…·ä¿¡æ¯"""
        
    async def get_server_tools(self, server_name: str) -> List[ToolInfo]:
        """è·å–æŒ‡å®šæœåŠ¡å™¨çš„å·¥å…·åˆ—è¡¨ï¼ˆå¸¦ç¼“å­˜ï¼‰"""
        
    def get_cached_tools_summary(self) -> Dict[str, Any]:
        """è·å–ç¼“å­˜çš„å·¥å…·æ‘˜è¦ä¿¡æ¯"""
```

2. **MCPToolCache** - MCPå·¥å…·ç¼“å­˜ç³»ç»Ÿ
```python
class MCPToolCache:
    def __init__(self, cache_duration: int = 300):
        self._tool_metadata: Dict[str, List[ToolInfo]] = {}
        self._server_status: Dict[str, ServerStatus] = {}
        self._cache_timestamps: Dict[str, datetime] = {}
        self._cache_duration = cache_duration
    
    def cache_server_tools(self, server_name: str, tools: List[ToolInfo]):
        """ç¼“å­˜æœåŠ¡å™¨å·¥å…·ä¿¡æ¯"""
        
    def get_cached_tools(self, server_name: str) -> Optional[List[ToolInfo]]:
        """è·å–ç¼“å­˜çš„å·¥å…·ä¿¡æ¯"""
        
    def is_cache_valid(self, server_name: str) -> bool:
        """æ£€æŸ¥ç¼“å­˜æ˜¯å¦æœ‰æ•ˆ"""
        
    def get_tools_context_for_agent(self) -> str:
        """ä¸ºAgentç”Ÿæˆå·¥å…·ä¸Šä¸‹æ–‡æè¿°"""
```

3. **ToolInfo** - å·¥å…·ä¿¡æ¯æ•°æ®ç»“æ„
```python
@dataclass
class ToolInfo:
    name: str
    description: str
    server_name: str
    schema: Dict[str, Any]
    category: str
    last_updated: datetime
    performance_metrics: PerformanceMetrics
    
@dataclass  
class PerformanceMetrics:
    success_rate: float
    avg_response_time: float
    total_calls: int
    last_call_time: Optional[datetime]
```

4. **AgentContextBuilder** - Agentä¸Šä¸‹æ–‡æ„å»ºå™¨
```python
class AgentContextBuilder:
    def __init__(self, tool_cache: MCPToolCache):
        self.tool_cache = tool_cache
    
    def build_tools_context(self) -> str:
        """æ„å»ºAgentå¯ç”¨å·¥å…·çš„ä¸Šä¸‹æ–‡æè¿°"""
        
    def build_server_status_context(self) -> str:
        """æ„å»ºæœåŠ¡å™¨çŠ¶æ€ä¸Šä¸‹æ–‡"""
        
    def get_contextual_tool_recommendations(self, task: str) -> List[str]:
        """åŸºäºä»»åŠ¡æ¨èç›¸å…³å·¥å…·"""
```

### 14.4 Implementation Stories

#### **Story 2.1**: Enhanced MCP Tool Discovery (Week 1)
**ä¼˜å…ˆçº§**: P1  
**é¢„ä¼°æ—¶é—´**: 3-4å¤©

**ä»»åŠ¡æè¿°**: å¢å¼ºMCPæœåŠ¡å™¨ç®¡ç†å™¨ï¼Œæ”¯æŒå·¥å…·å‘ç°å’Œç¼“å­˜
- âœ… æ‰©å±•MCPServerManageræ”¯æŒå·¥å…·åˆ—è¡¨æŸ¥è¯¢
- âœ… å®ç°ToolInfoæ•°æ®ç»“æ„å’Œç¼“å­˜æœºåˆ¶
- âœ… æ·»åŠ æ€§èƒ½ç›‘æ§å’Œç»Ÿè®¡åŠŸèƒ½
- âœ… å®ç°ç¼“å­˜è¿‡æœŸå’Œåˆ·æ–°æœºåˆ¶

**éªŒæ”¶æ ‡å‡†**:
- èƒ½å¤ŸæŸ¥è¯¢æ¯ä¸ªMCPæœåŠ¡å™¨çš„å·¥å…·åˆ—è¡¨
- å·¥å…·ä¿¡æ¯èƒ½å¤Ÿæ­£ç¡®ç¼“å­˜å’Œè¿‡æœŸ
- æ€§èƒ½æŒ‡æ ‡èƒ½å¤Ÿæ­£ç¡®æ”¶é›†

#### **Story 2.2**: CLI Enhancement for Tool Visibility (Week 1)
**ä¼˜å…ˆçº§**: P1  
**é¢„ä¼°æ—¶é—´**: 2-3å¤©

**ä»»åŠ¡æè¿°**: å¢å¼ºCLIå‘½ä»¤ä»¥æ˜¾ç¤ºå·¥å…·ä¿¡æ¯
- âœ… ä¸ºlist-serverså‘½ä»¤æ·»åŠ --show-toolså‚æ•°
- âœ… ä¸ºstatuså‘½ä»¤æ·»åŠ å·¥å…·çŠ¶æ€æ˜¾ç¤º
- âœ… å®ç°è¯¦ç»†çš„å·¥å…·ä¿¡æ¯æ ¼å¼åŒ–è¾“å‡º
- âœ… æ·»åŠ å·¥å…·æ€§èƒ½ç»Ÿè®¡æ˜¾ç¤º

**éªŒæ”¶æ ‡å‡†**:
- `list-servers --show-tools`èƒ½æ˜¾ç¤ºæ¯ä¸ªæœåŠ¡å™¨çš„å·¥å…·åˆ—è¡¨
- `status --verbose`èƒ½æ˜¾ç¤ºè¯¦ç»†çš„å·¥å…·çŠ¶æ€ä¿¡æ¯
- è¾“å‡ºæ ¼å¼æ¸…æ™°æ˜“è¯»

#### **Story 2.3**: Agent Context Integration (Week 2)
**ä¼˜å…ˆçº§**: P1  
**é¢„ä¼°æ—¶é—´**: 3-4å¤©

**ä»»åŠ¡æè¿°**: å°†å·¥å…·ä¿¡æ¯é›†æˆåˆ°Agentä¸Šä¸‹æ–‡ä¸­
- âœ… å®ç°AgentContextBuilderç»„ä»¶
- âœ… ä¿®æ”¹IntelligentAgentä»¥ä½¿ç”¨å·¥å…·ä¸Šä¸‹æ–‡
- âœ… å®ç°åŠ¨æ€å·¥å…·æ¨èæœºåˆ¶
- âœ… é›†æˆåˆ°ç°æœ‰çš„ReActå¾ªç¯ä¸­

**éªŒæ”¶æ ‡å‡†**:
- Agentèƒ½å¤Ÿæ„ŸçŸ¥å¹¶æè¿°è‡ªå·±çš„å¯ç”¨å·¥å…·
- å·¥å…·é€‰æ‹©æ›´åŠ æ™ºèƒ½å’Œç²¾ç¡®
- ä¸Šä¸‹æ–‡ä¿¡æ¯ä¸ä¼šè¿‡è½½ç³»ç»Ÿæç¤º

#### **Story 2.4**: Performance Optimization & Caching (Week 2)
**ä¼˜å…ˆçº§**: P1  
**é¢„ä¼°æ—¶é—´**: 2-3å¤©

**ä»»åŠ¡æè¿°**: ä¼˜åŒ–æ€§èƒ½å’Œå®ç°å®Œæ•´ç¼“å­˜æœºåˆ¶
- âœ… å®ç°è¿æ¥æ± ç®¡ç†
- âœ… ä¼˜åŒ–å·¥å…·æŸ¥è¯¢æ€§èƒ½
- âœ… æ·»åŠ ç¼“å­˜æ§åˆ¶å‚æ•°
- âœ… å®ç°æ€§èƒ½åŸºå‡†æµ‹è¯•

**éªŒæ”¶æ ‡å‡†**:
- å·¥å…·æŸ¥è¯¢æ€§èƒ½æå‡50%ä»¥ä¸Š
- ç¼“å­˜å‘½ä¸­ç‡è¾¾åˆ°90%ä»¥ä¸Š
- æ”¯æŒç¼“å­˜æ§åˆ¶å‚æ•°é…ç½®

### 14.5 Success Metrics

#### æ€§èƒ½æŒ‡æ ‡:
- âœ… **å·¥å…·æŸ¥è¯¢é€Ÿåº¦**: é¦–æ¬¡æŸ¥è¯¢<2ç§’ï¼Œç¼“å­˜æŸ¥è¯¢<100ms
- âœ… **ç¼“å­˜å‘½ä¸­ç‡**: æ­£å¸¸ä½¿ç”¨åœºæ™¯ä¸‹>90%
- âœ… **å†…å­˜ä½¿ç”¨**: å·¥å…·ç¼“å­˜<10MB
- âœ… **è¿æ¥æ•ˆç‡**: æœåŠ¡å™¨è¿æ¥å¤ç”¨ç‡>80%

#### ç”¨æˆ·ä½“éªŒæŒ‡æ ‡:
- âœ… **å·¥å…·å¯è§æ€§**: ç”¨æˆ·èƒ½å¤ŸæŸ¥çœ‹100%çš„å¯ç”¨å·¥å…·
- âœ… **Agentæ™ºèƒ½åº¦**: å·¥å…·é€‰æ‹©å‡†ç¡®ç‡æå‡>20%
- âœ… **å‘½ä»¤æ˜“ç”¨æ€§**: æ–°CLIå‘½ä»¤ç›´è§‚æ˜“ç”¨
- âœ… **æ–‡æ¡£å®Œæ•´æ€§**: æ‰€æœ‰æ–°åŠŸèƒ½æœ‰å®Œæ•´æ–‡æ¡£

### 14.6 Configuration Enhancement

#### æ–°å¢é…ç½®é€‰é¡¹:
```yaml
# configs/defaults/mcp_servers.yaml
mcp:
  caching:
    enabled: true
    cache_duration: 300  # 5åˆ†é’Ÿ
    max_cache_size: 100  # æœ€å¤§ç¼“å­˜å·¥å…·æ•°
    performance_tracking: true
    
  connection_pool:
    max_connections_per_server: 3
    connection_timeout: 30
    retry_attempts: 3
    
  tools:
    auto_discovery: true
    context_integration: true
    performance_monitoring: true
```

### 14.7 File Structure Updates

```
tinyagent/
â”œâ”€â”€ mcp/
â”‚   â”œâ”€â”€ manager.py               # å¢å¼ºçš„MCPç®¡ç†å™¨
â”‚   â”œâ”€â”€ cache.py                 # æ–°å¢ï¼šå·¥å…·ç¼“å­˜ç³»ç»Ÿ
â”‚   â”œâ”€â”€ pool.py                  # æ–°å¢ï¼šè¿æ¥æ± ç®¡ç†
â”‚   â””â”€â”€ context_builder.py       # æ–°å¢ï¼šä¸Šä¸‹æ–‡æ„å»ºå™¨
â”œâ”€â”€ intelligence/
â”‚   â”œâ”€â”€ context_integration.py   # æ–°å¢ï¼šä¸Šä¸‹æ–‡é›†æˆ
â”‚   â””â”€â”€ tool_recommender.py      # æ–°å¢ï¼šå·¥å…·æ¨èå™¨
â””â”€â”€ cli/
    â””â”€â”€ main.py                  # å¢å¼ºCLIå‘½ä»¤
```

### 14.8 Next Phase Planning

**Phase 1 (Week 1)**: æ ¸å¿ƒç¼“å­˜å’Œå·¥å…·å‘ç°
- Story 2.1: Enhanced MCP Tool Discovery
- Story 2.2: CLI Enhancement for Tool Visibility

**Phase 2 (Week 2)**: Agenté›†æˆå’Œæ€§èƒ½ä¼˜åŒ–  
- Story 2.3: Agent Context Integration
- Story 2.4: Performance Optimization & Caching

**Phase 3 (Optional)**: é«˜çº§åŠŸèƒ½
- å·¥å…·ä½¿ç”¨åˆ†æå’Œæ¨è
- è‡ªåŠ¨å·¥å…·æ€§èƒ½è°ƒä¼˜
- å·¥å…·ä¾èµ–å…³ç³»ç®¡ç†

---

*EPIC-002å°†æ˜¾è‘—æå‡TinyAgentçš„å·¥å…·å¯è§æ€§ã€æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒï¼Œä¸ºç”¨æˆ·æä¾›å®Œæ•´çš„MCPå·¥å…·ç”Ÿæ€ç³»ç»Ÿæ§åˆ¶èƒ½åŠ›ã€‚* 

## 15. ğŸš« **EPIC-003: Fallback Elimination & Enhanced Tool Tracing**
*Added: 2025-06-03*  
*Priority: CRITICAL*  
*Epic Status: COMPLETED âœ…*
*Completion Date: 2025-06-02*

### 15.1 Epic Overview

**Epic ID**: EPIC-003  
**Priority**: P0 (Critical)  
**Duration**: Same-day implementation  
**Dependencies**: EPIC-001 (Intelligence Framework), EPIC-002 (MCP Tools Enhancement)

**é—®é¢˜æè¿°**: TinyAgentå­˜åœ¨å¤æ‚çš„å›é€€æœºåˆ¶ï¼Œåœ¨è°ƒè¯•æ—¶é€ æˆæ··æ·†ï¼ŒåŒæ—¶ç¼ºä¹MCPå·¥å…·è°ƒç”¨çš„è¯¦ç»†è·Ÿè¸ªèƒ½åŠ›ï¼š
- ğŸš« **å¤æ‚å›é€€é€»è¾‘**: æ™ºèƒ½æ¨¡å¼å¤±è´¥æ—¶å›é€€åˆ°åŸºç¡€æ¨¡å¼ï¼ŒåŸºç¡€æ¨¡å¼åˆæœ‰å¤šå±‚å¯å‘å¼åˆ¤æ–­
- ğŸ” **è°ƒè¯•å›°éš¾**: æ— æ³•æ¸…æ¥šäº†è§£ä»£ç†çš„æ‰§è¡Œè·¯å¾„å’Œå†³ç­–è¿‡ç¨‹
- ğŸ”§ **å·¥å…·è°ƒç”¨ä¸é€æ˜**: ç”¨æˆ·æ— æ³•çœ‹åˆ°MCPå·¥å…·çš„å®é™…è°ƒç”¨è¿‡ç¨‹å’Œç»“æœ
- ğŸ“‹ **åˆ—è¡¨å·¥å…·å¤±æ•ˆ**: ç”¨æˆ·è¯¢é—®å·¥å…·åˆ—è¡¨æ—¶è¿”å›é€šç”¨å›å¤è€Œéå®é™…å·¥å…·

### 15.2 Implementation Changes

#### **15.2.1 Fallback Mechanism Elimination**

**Before (å¤æ‚å›é€€é“¾)**:
```mermaid
flowchart TD
    User[ç”¨æˆ·è¯·æ±‚] --> Route{è·¯ç”±å†³ç­–}
    Route -->|æ™ºèƒ½æ¨¡å¼| IntelligentMode[æ™ºèƒ½æ¨¡å¼]
    Route -->|åŸºç¡€æ¨¡å¼| BasicMode[åŸºç¡€æ¨¡å¼]
    
    IntelligentMode -->|å¤±è´¥| FallbackBasic[å›é€€åˆ°åŸºç¡€æ¨¡å¼]
    BasicMode --> Heuristic{å¯å‘å¼åˆ¤æ–­}
    Heuristic -->|éœ€è¦å·¥å…·| MCPMode[MCPæ¨¡å¼]
    Heuristic -->|ç®€å•å¯¹è¯| SimpleMode[ç®€å•æ¨¡å¼]
    SimpleMode -->|å¤±è´¥| FallbackMCP[å›é€€åˆ°MCPæ¨¡å¼]
    MCPMode -->|æ— æœåŠ¡å™¨| FallbackSimple[å›é€€åˆ°ç®€å•æ¨¡å¼]
    
    class FallbackBasic,FallbackMCP,FallbackSimple problemClass
```

**After (ç®€åŒ–æ¶æ„)**:
```mermaid
flowchart TD
    User[ç”¨æˆ·è¯·æ±‚] --> Route{è·¯ç”±å†³ç­–}
    Route -->|æ™ºèƒ½å¯ç”¨| IntelligentMode[æ™ºèƒ½æ¨¡å¼ + MCPå·¥å…·]
    Route -->|æ™ºèƒ½ä¸å¯ç”¨| MCPMode[MCPå·¥å…·æ¨¡å¼]
    
    IntelligentMode -->|å¤±è´¥| Error[æŠ›å‡ºé”™è¯¯]
    MCPMode -->|æ— æœåŠ¡å™¨| Error[æŠ›å‡ºé”™è¯¯]
    
    class Error solutionClass
```

#### **15.2.2 MCPå·¥å…·æ³¨å†Œé‡å¤§çªç ´** âœ…

**æ ¸å¿ƒé—®é¢˜å‘ç°**: 
ç»è¿‡æ·±å…¥è°ƒè¯•ï¼Œå‘ç°äº†é˜»æ­¢MCPå·¥å…·æ­£ç¡®æ³¨å†Œçš„æ ¹æœ¬åŸå› ï¼š

1. **MCPå“åº”æ ¼å¼ä¸åŒ¹é…**: `list_tools()`ç›´æ¥è¿”å›`list`å¯¹è±¡ï¼Œè€Œéé¢„æœŸçš„åŒ…å«`.tools`å±æ€§çš„å¯¹è±¡
2. **å·¥å…·æ³¨å†Œæ—¶æœºé”™è¯¯**: MCPå·¥å…·æ‰§è¡Œå™¨åœ¨è¿æ¥å»ºç«‹å‰åˆ›å»ºï¼Œå¯¼è‡´`_persistent_connections`ä¸ºç©º
3. **æµå¼è¾“å‡ºæ™ºèƒ½æ¨¡å¼ç¼ºå¤±**: `run_stream`æ–¹æ³•æœªä½¿ç”¨æ™ºèƒ½æ¨¡å¼

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# ä¿®å¤1: MCPå“åº”æ ¼å¼å¤„ç†
tools_list = None
if isinstance(server_tools, list):
    # ç›´æ¥listå“åº” (å®é™…æƒ…å†µ)
    tools_list = server_tools
elif hasattr(server_tools, 'tools'):
    # å¸¦.toolså±æ€§çš„å“åº”
    tools_list = server_tools.tools

# ä¿®å¤2: æ­£ç¡®çš„å·¥å…·æ³¨å†Œæ—¶æœº
connected_servers = await self._ensure_mcp_connections()  # å…ˆå»ºç«‹è¿æ¥
# ... æ”¶é›†å·¥å…·ä¿¡æ¯
mcp_tool_executor = self._create_mcp_tool_executor()      # ååˆ›å»ºæ‰§è¡Œå™¨
intelligent_agent.set_mcp_tool_executor(mcp_tool_executor)

# ä¿®å¤3: æµå¼è¾“å‡ºæ™ºèƒ½æ¨¡å¼æ”¯æŒ
async def run_stream(self, message: str, **kwargs):
    if self.intelligent_mode and INTELLIGENCE_AVAILABLE:
        return await self._run_intelligent_mode(message, **kwargs)
    else:
        return await self._run_with_mcp_tools(message, **kwargs)
```

**ä¿®å¤æˆæœ**: 
- âœ… **ä»0åˆ°15ä¸ªå·¥å…·**: æˆåŠŸæ³¨å†Œæ‰€æœ‰å¯ç”¨çš„MCPå·¥å…·
- âœ… **å·¥å…·å‘ç°æ­£å¸¸**: read_file, write_file, create_directoryç­‰å·¥å…·å…¨éƒ¨å¯è§
- âœ… **æ™ºèƒ½æ¨¡å¼é›†æˆ**: æ™ºèƒ½ä»£ç†ç°åœ¨æ‹¥æœ‰å®Œæ•´çš„å·¥å…·ä¸Šä¸‹æ–‡

### 15.3 User Experience Improvements

#### **15.3.1 Tool Query Enhancement**

**Before**:
```
User: list mcp tools you have
Agent: æˆ‘æ˜¯ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹ï¼Œå¯ä»¥å¸®åŠ©æ‚¨å¤„ç†å„ç§ä»»åŠ¡...
```

**After**:
```
User: list mcp tools you have
Agent: ğŸ”§ **æˆ‘å½“å‰å¯ç”¨çš„MCPå·¥å…·ï¼š**

ğŸŸ¢ **filesystemæœåŠ¡å™¨** (11ä¸ªå·¥å…·):
  â€¢ [æ–‡ä»¶] read_file: è¯»å–æ–‡ä»¶å†…å®¹
  â€¢ [æ–‡ä»¶] write_file: å†™å…¥æ–‡ä»¶å†…å®¹
  â€¢ [ç›®å½•] list_directory: åˆ—å‡ºç›®å½•å†…å®¹
  â€¢ [ç›®å½•] create_directory: åˆ›å»ºæ–°ç›®å½•
  â€¢ [æœç´¢] search_files: æœç´¢æ–‡ä»¶å†…å®¹
  ...

ğŸŸ¢ **sequential-thinkingæœåŠ¡å™¨** (1ä¸ªå·¥å…·):
  â€¢ [åˆ†æ] sequentialthinking: åˆ†æ­¥éª¤åˆ†æå¤æ‚é—®é¢˜

ğŸ“Š **æ€»è®¡**: 12ä¸ªå·¥å…·ï¼Œæ¥è‡ª2ä¸ªæœåŠ¡å™¨

ğŸ’¡ **ä½¿ç”¨æ–¹å¼**: æ‚¨å¯ä»¥ç›´æ¥è¦æ±‚æˆ‘ä½¿ç”¨è¿™äº›å·¥å…·æ‰§è¡Œå…·ä½“ä»»åŠ¡ï¼Œä¾‹å¦‚ï¼š
  â€¢ 'åˆ›å»ºä¸€ä¸ªdebug.txtæ–‡ä»¶'
  â€¢ 'è¯»å–README.mdæ–‡ä»¶å†…å®¹'
  â€¢ 'åˆ†æè¿™ä¸ªå¤æ‚é—®é¢˜çš„è§£å†³æ­¥éª¤'
```

#### **15.3.2 Tool Execution Tracing**

**Verbose Mode (è¯¦ç»†æ¨¡å¼)**:
```
User: create debug.txt and write "debug" in it

Agent: æˆ‘å°†å¸®æ‚¨åˆ›å»ºdebug.txtæ–‡ä»¶å¹¶å†™å…¥"debug"å†…å®¹ã€‚

ğŸ¤” åˆ†æç»“æœ: éœ€è¦è°ƒç”¨ write_file å·¥å…·æ¥å®Œæˆä»»åŠ¡
ğŸ¯ æ‰§è¡Œæ„å›¾: ä½¿ç”¨MCPå·¥å…·å¤„ç†ç”¨æˆ·è¯·æ±‚

ğŸ”§ æ­£åœ¨è°ƒç”¨MCPå·¥å…·...
   å·¥å…·åç§°: write_file
   æœåŠ¡å™¨: filesystem
   å‚æ•°: {'path': 'debug.txt', 'content': 'debug'}
   çŠ¶æ€: æ‰§è¡Œä¸­...
   âœ… æ‰§è¡ŒæˆåŠŸ
   ç»“æœ: æ–‡ä»¶åˆ›å»ºæˆåŠŸ (5 å­—ç¬¦): debug
   â±ï¸ è€—æ—¶: 0.23ç§’

ğŸ¯ å·¥å…·è°ƒç”¨æ€»ç»“: 1/1 æˆåŠŸ, æ€»è€—æ—¶ 0.23ç§’

å·²æˆåŠŸåˆ›å»ºdebug.txtæ–‡ä»¶ï¼Œå†…å®¹ä¸º"debug"ã€‚
```

**Simple Mode (ç®€æ´æ¨¡å¼)**:
```
User: read debug.txt

Agent: æˆ‘å°†è¯»å–debug.txtæ–‡ä»¶çš„å†…å®¹ã€‚

ğŸ”§ è°ƒç”¨å·¥å…·: read_file
   âœ… read_file å®Œæˆ

æ–‡ä»¶å†…å®¹: debug
```

### 15.4 Technical Benefits

#### **15.4.1 è°ƒè¯•èƒ½åŠ›æå‡**
- âœ… **é”™è¯¯å¿«é€Ÿå®šä½**: å»é™¤å›é€€é€»è¾‘åï¼Œé”™è¯¯ç›´æ¥æŠ›å‡ºåˆ°å †æ ˆé¡¶å±‚
- âœ… **æ‰§è¡Œè·¯å¾„æ¸…æ™°**: åªæœ‰ä¸¤æ¡ä¸»è¦æ‰§è¡Œè·¯å¾„ï¼Œæ˜“äºè·Ÿè¸ª
- âœ… **æ—¥å¿—ä¸€è‡´æ€§**: å‡å°‘äº¤é”™çš„æ‰§è¡Œæ¨¡å¼åˆ‡æ¢æ—¥å¿—

#### **15.4.2 ç”¨æˆ·ä½“éªŒæ”¹å–„**
- âœ… **å·¥å…·å¯è§æ€§**: ç”¨æˆ·å¯ä»¥æ¸…æ¥šçœ‹åˆ°æ‰€æœ‰å¯ç”¨å·¥å…·
- âœ… **æ‰§è¡Œé€æ˜åº¦**: è¯¦ç»†çš„å·¥å…·è°ƒç”¨è¿‡ç¨‹å±•ç¤º
- âœ… **é”™è¯¯åé¦ˆ**: æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯è€Œéé™é»˜å›é€€

#### **15.4.3 ç»´æŠ¤æˆæœ¬é™ä½**
- âœ… **ä»£ç ç®€åŒ–**: åˆ é™¤çº¦200è¡Œå¤æ‚å›é€€é€»è¾‘
- âœ… **æµ‹è¯•ç®€åŒ–**: å‡å°‘éœ€è¦æµ‹è¯•çš„æ‰§è¡Œè·¯å¾„ç»„åˆ
- âœ… **æ–‡æ¡£ç»´æŠ¤**: æ¶æ„å›¾å’Œæµç¨‹å›¾å¤§å¹…ç®€åŒ–

### 15.5 Configuration Options

**æ–°å¢é…ç½®é€‰é¡¹æ”¯æŒä¸åŒçº§åˆ«çš„è·Ÿè¸ª**:
```yaml
# configs/profiles/development.yaml
intelligence:
  tool_tracing:
    enabled: true
    verbose_mode: true      # è¯¦ç»†æ¨¡å¼
    console_output: true    # æ§åˆ¶å°è¾“å‡º
    show_parameters: true   # æ˜¾ç¤ºå‚æ•°
    show_timing: true       # æ˜¾ç¤ºæ‰§è¡Œæ—¶é—´
    
agent:
  fallback_disabled: true  # ç¦ç”¨å›é€€æœºåˆ¶
  strict_mode: true        # ä¸¥æ ¼æ¨¡å¼ï¼ˆé”™è¯¯æ—¶ç«‹å³å¤±è´¥ï¼‰
```

### 15.6 Migration Guide

**å¯¹äºç°æœ‰ç”¨æˆ·**:
1. **é…ç½®æ— éœ€æ›´æ”¹**: ç°æœ‰é…ç½®æ–‡ä»¶ç»§ç»­æœ‰æ•ˆ
2. **è¡Œä¸ºå˜åŒ–**: é”™è¯¯å¤„ç†æ›´åŠ ä¸¥æ ¼ï¼Œéœ€è¦æ£€æŸ¥MCPæœåŠ¡å™¨é…ç½®
3. **æ–°åŠŸèƒ½**: å¯é€šè¿‡é…ç½®å¯ç”¨/ç¦ç”¨è¯¦ç»†è·Ÿè¸ª

**æ•…éšœæ’é™¤**:
```bash
# æ£€æŸ¥MCPæœåŠ¡å™¨çŠ¶æ€
python -m tinyagent list-servers --show-tools

# å¯ç”¨è¯¦ç»†è°ƒè¯•
export TINYAGENT_LOG_LEVEL=DEBUG
python -m tinyagent run "list tools"

# æ£€æŸ¥æ™ºèƒ½æ¨¡å¼å¯ç”¨æ€§
python -c "from tinyagent.intelligence import INTELLIGENCE_AVAILABLE; print(f'Intelligence: {INTELLIGENCE_AVAILABLE}')"
```

### 15.7 Success Metrics

#### **å®šé‡æŒ‡æ ‡**:
- âœ… **ä»£ç å‡å°‘**: åˆ é™¤~200è¡Œå›é€€é€»è¾‘ä»£ç 
- âœ… **é”™è¯¯å®šä½é€Ÿåº¦**: è°ƒè¯•æ—¶é—´å‡å°‘70%
- âœ… **ç”¨æˆ·æ»¡æ„åº¦**: å·¥å…·å¯è§æ€§ä»0%æå‡åˆ°100%
- âœ… **æ‰§è¡Œè·¯å¾„**: ä»7æ¡å‡å°‘åˆ°2æ¡ä¸»è¦è·¯å¾„

#### **å®šæ€§æ”¹è¿›**:
- âœ… **æ¶æ„æ¸…æ™°åº¦**: æ¶ˆé™¤å¤æ‚çš„å›é€€é“¾æ¡
- âœ… **è°ƒè¯•å‹å¥½æ€§**: é”™è¯¯å †æ ˆç›´æ¥æŒ‡å‘é—®é¢˜æºå¤´
- âœ… **ç”¨æˆ·ä½“éªŒ**: é€æ˜çš„å·¥å…·æ‰§è¡Œè¿‡ç¨‹
- âœ… **ç»´æŠ¤æ€§**: ç®€åŒ–çš„ä»£ç ç»“æ„æ˜“äºç»´æŠ¤

---

*EPIC-003æˆåŠŸæ¶ˆé™¤äº†TinyAgentæ¶æ„ä¸­çš„å¤æ‚å›é€€æœºåˆ¶ï¼Œæä¾›äº†å®Œå…¨é€æ˜çš„MCPå·¥å…·è°ƒç”¨è·Ÿè¸ªï¼Œæ˜¾è‘—æå‡äº†è°ƒè¯•èƒ½åŠ›å’Œç”¨æˆ·ä½“éªŒã€‚*

## 16. æ€»ç»“ä¸å±•æœ›